#!/bin/bash

src=$1
dest=laf/textures

tmpfile="filter-textures.scm"

rm -f $tmpfile
echo '(load "'$src/../../../scripts/build-mipmap.scm'")' > $tmpfile
echo '(load "'$src/../../../scripts/scale-convert.scm'")' >> $tmpfile

anynewer=0

function mkmipmaps {
  frame=$1
  mode=$2
  nstate=$3
  qstate=$4
  frozen=$5

  if [ $frozen -eq 1 ]
  then 
    simg=`printf "%s.%04d.sgi" $src/$mode"Frozen" $frame`
    dir=`echo $dest/$nstate-$qstate"-Frozen"-$mode`
  else 
    simg=`printf "%s.%04d.sgi" $src/$mode $frame`
    dir=`echo $dest/$nstate-$qstate-$mode`
  fi

  if [ ! -d $dir ]
  then 
    mkdir -p $dir
  fi

  filter=0
  size=128
  while [ $size -gt 1 ]
  do
    size=$(($size / 2)) 
  	
    dimg=$dir/texture.$size.png
    if [ $simg -nt $dimg ] 
    then
      filter=1
    fi
  done

  if [ $filter -eq 1 ]
  then 
    printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
    anynewer=1
  fi
}

function mkicon {
  frame=$1
  mode=$2
  nstate=$3
  qstate=$4  
  frozen=$5

  if [ $frozen -eq 1 ]
  then 
    simg=`printf "%s.%04d.sgi" $src/$mode"Frozen" $frame`
    dir=`echo $dest/$nstate-$qstate"-Frozen"-$mode`
  else 
    simg=`printf "%s.%04d.sgi" $src/$mode $frame`
    dir=`echo $dest/$nstate-$qstate-$mode`
  fi

  if [ ! -d $dir ]
  then 
    mkdir -p $dir
  fi

  dimg=$dir/texture.21.png
  if [ $simg -nt $dimg ] 
  then
    printf '(scale-convert "%s" "%s" 21)\n' $simg $dimg >> $tmpfile
    anynewer=1
  fi
}

for mode in Normal Selected Primary
do
  frame=0
  for nstate in Pending CheckedIn Identical NeedsCheckOut Modified \
                Conflicted ModifiedLinks Missing Added Obsolete \
                NeedsCheckOutMicro NeedsCheckOutMajor 
  do
    for qstate in Stale Queued Running Aborted Failed Finished Paused Undefined
    do
      if [ "$nstate" != "Added" -a "$nstate" != "Obsolete" ] 
      then 
        mkmipmaps $frame $mode $nstate $qstate 0
      fi
      mkicon $frame $mode $nstate $qstate 0
      frame=$(($frame + 1))	
    done
  done

  frame=96
  for extra in Blank Collapsed
  do 
    simg=`printf "%s.%04d.sgi" $src/$mode $frame`

    if [ $extra == "Collapsed" ]
    then 
      dir=`echo $dest/$extra`
    else 
      dir=`echo $dest/$extra-$mode`
    fi

    dimg=$dir/texture.$size.png

    if [ ! -d $dir ]
    then 
      mkdir -p $dir
    fi

    filter=0
    size=128
    while [ $size -gt 1 ]
    do
      size=$(($size / 2)) 
  
      dimg=$dir/texture.$size.png

      if [ $simg -nt $dimg ] 
      then
        filter=1
      fi
    done

    if [ $filter -eq 1 ]
    then 
      printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
      anynewer=1
    fi

    frame=$(($frame + 1))
  done

  frame=96
  for extra in Blank Collapsed
  do 
    simg=`printf "%s.%04d.sgi" $src/$mode $frame`

    if [ $extra == "Collapsed" ]
    then 
      dir=`echo $dest/$extra`
    else 
      dir=`echo $dest/$extra-$mode`
    fi

    if [ ! -d $dir ]
    then 
      mkdir -p $dir
    fi

    dimg=$dir/texture.21.png
    if [ $simg -nt $dimg ] 
    then
      printf '(scale-convert "%s" "%s" 21)\n' $simg $dimg >> $tmpfile
      anynewer=1
    fi
    
    frame=$(($frame + 1))	
  done  

  nstate=Identical

  qstate=Finished
  frame=21
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1

  qstate=Stale
  frame=16
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1


  nstate=ModifiedLinks

  qstate=Finished
  frame=53
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1

  qstate=Stale
  frame=48
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1


  nstate=NeedsCheckOutMicro

  qstate=Finished
  frame=85
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1

  qstate=Stale
  frame=80
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1


  nstate=NeedsCheckOut

  qstate=Finished
  frame=29
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1

  qstate=Stale
  frame=24
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1


  nstate=NeedsCheckOutMajor

  qstate=Finished
  frame=29
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1

  qstate=Stale
  frame=24
  mkmipmaps $frame $mode $nstate $qstate 1
  mkicon $frame $mode $nstate $qstate 1
done

frame=0
for rel in None OneToOne All
do
  simg=`printf "%s/LinkIcons-painted.%04d.sgi" $src $frame`
  dir=`echo $dest/LinkRelationship-$rel`
  dimg=$dir/texture.$size.png

  if [ ! -d $dir ]
  then 
    mkdir -p $dir
  fi

  filter=0
  size=128
  while [ $size -gt 1 ]
  do
    size=$(($size / 2)) 
  
    dimg=$dir/texture.$size.png

    if [ $simg -nt $dimg ] 
    then
      filter=1
    fi
  done

  if [ $filter -eq 1 ]
  then 
    printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
    anynewer=1
  fi

  frame=$(($frame + 1))
done

if [ $anynewer -eq 1 ]
then 
  echo '(gimp-quit 1)' >> $tmpfile

  cat $tmpfile
  time @GIMP@ -i -d -b '(load "'$tmpfile'")'
fi

rm -f $tmpfile

#!/bin/bash

src=$1
dest=laf/textures

tmpfile="filter-textures.scm"

rm -f $tmpfile
echo '(load "'$src/../../../scripts/build-mipmap.scm'")' > $tmpfile

anynewer=0
for mode in Normal Selected Primary
do
  frame=0
  for nstate in Pending CheckedIn Identical NeedsCheckOut Modified Conflicted ModifiedLinks
  do
    for qstate in Stale Queued Running Missing Failed Finished
    do
      simg=`printf "%s.%04d.sgi" $src/$mode $frame`
      dir=`echo $dest/$nstate-$qstate-$mode`

      if [ ! -d $dir ]
      then 
        mkdir -p $dir
      fi

      filter=0
      size=128
      while [ $size -gt 1 ]
      do
	size=$(($size / 2)) 
	
	dimg=$dir/texture.$size.png
	if [ $simg -nt $dimg ] 
	then
	  filter=1
        fi
      done

      if [ $filter -eq 1 ]
      then 
        printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
        anynewer=1
      fi

      frame=$(($frame + 1))	
    done
  done

  for extra in Blank Collapsed
  do 
    simg=`printf "%s.%04d.sgi" $src/$mode $frame`
    dir=`echo $dest/$extra-$mode`
    dimg=$dir/texture.$size.png

    if [ ! -d $dir ]
    then 
      mkdir -p $dir
    fi

    filter=0
    size=128
    while [ $size -gt 1 ]
    do
      size=$(($size / 2)) 
  
      dimg=$dir/texture.$size.png

      if [ $simg -nt $dimg ] 
      then
        filter=1
      fi
    done

    if [ $filter -eq 1 ]
    then 
      printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
      anynewer=1
    fi

    frame=$(($frame + 1))
  done
done

frame=0
for rel in None OneToOne All
do
  simg=`printf "%s/LinkIcons-painted.%04d.sgi" $src $frame`
  dir=`echo $dest/LinkRelationship-$rel`
  dimg=$dir/texture.$size.png

  if [ ! -d $dir ]
  then 
    mkdir -p $dir
  fi

  filter=0
  size=128
  while [ $size -gt 1 ]
  do
    size=$(($size / 2)) 
  
    dimg=$dir/texture.$size.png

    if [ $simg -nt $dimg ] 
    then
      filter=1
    fi
  done

  if [ $filter -eq 1 ]
  then 
    printf '(build-mipmap "%s" "%s/texture" 64)\n' $simg $dir >> $tmpfile
    anynewer=1
  fi

  frame=$(($frame + 1))
done

if [ $anynewer -eq 1 ]
then 
  echo '(gimp-quit 1)' >> $tmpfile

  cat $tmpfile
  time @GIMP@ -i -d -b '(load "'$tmpfile'")'
fi

rm -f $tmpfile
